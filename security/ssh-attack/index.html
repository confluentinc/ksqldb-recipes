<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>Detect and Analyze SSH Attacks - ksqlDB Recipes</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../../css/theme.css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Detect and Analyze SSH Attacks";
    var mkdocs_page_input_path = "security/ssh-attack/index.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> ksqlDB Recipes</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../..">ksqlDB Recipes</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Customer 360</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="#">Clickstream</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../customer-360/clickstream/">Understand User Behavior with Clickstream Data</a>
                </li>
    </ul>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Fin serv</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="#">Credit card activity</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../fin-serv/credit-card-activity/">Detect Unusual Credit Card Activity</a>
                </li>
    </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="#">Denormalization</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../fin-serv/denormalization/">Denormalize Change Data Capture (CDC) for Orders</a>
                </li>
    </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="#">Payment status check</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../fin-serv/payment-status-check/">Check Payment Requests</a>
                </li>
    </ul>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Internet of things</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="#">Coalesce</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../internet-of-things/coalesce/">Coalesce Telemetry</a>
                </li>
    </ul>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Operations</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="#">Salesforce</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../operations/salesforce/">Handle Corrupted Data From Salesforce</a>
                </li>
    </ul>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Retail</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="#">Fleet management</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../retail/fleet_management/">Build a Real-time Fleet Management System</a>
                </li>
    </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="#">Inventory</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../retail/inventory/">View Real-time Inventory</a>
                </li>
    </ul>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Security</span></p>
                <ul class="current">
                    <li class="toctree-l1 current"><a class="reference internal current" href="#">Ssh attack</a>
    <ul class="current">
                <li class="toctree-l2 current"><a class="reference internal current" href="./">Detect and Analyze SSH Attacks</a>
    <ul class="current">
    <li class="toctree-l3"><a class="reference internal" href="#what-is-it">What is it?</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#get-started">Get Started</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#step-by-step">Step-by-Step</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#setup-your-environment">Setup your Environment</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#read-the-data-in">Read the data in</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#run-stream-processing-app">Run stream processing app</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#full-ksqldb-statements">Full ksqlDB Statements</a>
    </li>
    </ul>
                </li>
    </ul>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Shared</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../shared/ccloud_launch/">Ccloud launch</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../shared/ccloud_setup/">Ccloud setup</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../shared/code_summary/">Code summary</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../shared/connect/">Connect</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../shared/manual_cue/">Manual cue</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../shared/manual_insert/">Manual insert</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">ksqlDB Recipes</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>Security &raquo;</li>
        
      
        
          <li>Ssh attack &raquo;</li>
        
      
    
    <li>Detect and Analyze SSH Attacks</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  
  <hr/>
</div>

          <div role="main">
            <div class="section">
              
                <h1 id="detect-and-analyze-ssh-attacks">Detect and Analyze SSH Attacks</h1>
<h2 id="what-is-it">What is it?</h2>
<p>There are lots of ways SSH can be abused but one of the most straightforward ways to detect a problem is to monitor for rejected logins.
This recipe processes Syslog data to detect bad logins and streams out those pairs of usernames and IP addresses.
With ksqlDB, you can filter and react to events in real time rather than performing historical analysis of Syslog data from cold storage.</p>
<p><img alt="ssh-attack" src="../../img/ssh-attack.png" /></p>
<h2 id="get-started">Get Started</h2>
<p>Click below to automatically launch this recipe in Confluent Cloud (alternatively: follow the step-by-step instructions that follow).</p>
<p><a href="https://www.confluent.io/confluent-cloud/tryfree/"><img src="../../img/launch.png" /></a></p>
<h2 id="step-by-step">Step-by-Step</h2>
<h3 id="setup-your-environment">Setup your Environment</h3>
<p>Setup your environment in <a href="https://www.confluent.io/confluent-cloud/tryfree/">Confluent Cloud</a>, a fully-managed Apache Kafka service.</p>
<p>Then proceed with the recipe, which can be executed with <code>SQL</code> syntax using Confluent Cloud ksqlDB, which now has connector integration for reading and writing data to other data sources and sinks, as well as language for processing the data.</p>
<h3 id="read-the-data-in">Read the data in</h3>
<p>This recipe is a great demonstration on how to run a self-managed connector, to push syslog data into Confluent Cloud into a Kafka topic called <code>syslog</code>.</p>
<p>Create a file called <code>Dockerfile</code> to bundle a connect worker with <code>kafka-connect-syslog</code>:</p>
<pre><code class="language-text">FROM confluentinc/cp-server-connect-base:6.2.0

ENV CONNECT_PLUGIN_PATH=&quot;/usr/share/java,/usr/share/confluent-hub-components&quot;

USER root
COPY --chown=appuser:appuser include/etc/confluent/docker /etc/confluent/docker
USER appuser

ARG CONNECTOR_OWNER=confluentinc
ARG CONNECTOR_NAME
ARG CONNECTOR_VERSION
RUN confluent-hub install --no-prompt confluent-hub install confluentinc/kafka-connect-syslog:1.3.4

CMD [&quot;/etc/confluent/docker/run&quot;]
</code></pre>
<p>Build the custom Docker image with the command:</p>
<pre><code>docker build \
   -t localbuild/connect_distributed_with_syslog:1.3.4 \
   -f Dockerfile .
</code></pre>
<p>Create a file called <code>docker-compose.yml</code> with the following content, substituting your Confluent Cloud connection information:</p>
<pre><code class="language-text">---
version: '2'
services:

  connect:
    image: localbuild/connect_distributed_with_syslog:1.3.4
    hostname: connect
    container_name: connect
    ports:
      - &quot;8083:8083&quot;
    environment:
      CONNECT_BOOTSTRAP_SERVERS: $BOOTSTRAP_SERVERS
      CONNECT_REST_PORT: 8083
      CONNECT_GROUP_ID: &quot;connect&quot;
      CONNECT_CONFIG_STORAGE_TOPIC: recipe-connect-configs
      CONNECT_OFFSET_STORAGE_TOPIC: recipe-connect-offsets
      CONNECT_STATUS_STORAGE_TOPIC: recipe-connect-status
      CONNECT_REPLICATION_FACTOR: 3
      CONNECT_CONFIG_STORAGE_REPLICATION_FACTOR: 3
      CONNECT_OFFSET_STORAGE_REPLICATION_FACTOR: 3
      CONNECT_STATUS_STORAGE_REPLICATION_FACTOR: 3
      CONNECT_KEY_CONVERTER: &quot;org.apache.kafka.connect.storage.StringConverter&quot;
      CONNECT_VALUE_CONVERTER: &quot;org.apache.kafka.connect.json.JsonConverter&quot;
      CONNECT_REST_ADVERTISED_HOST_NAME: &quot;connect&quot;
      CONNECT_PLUGIN_PATH: &quot;/usr/share/java,/usr/share/confluent-hub-components&quot;
      CONNECT_LOG4J_ROOT_LOGLEVEL: INFO
      CONNECT_LOG4J_LOGGERS: org.reflections=ERROR
      # Connect worker
      CONNECT_SECURITY_PROTOCOL: SASL_SSL
      CONNECT_SASL_JAAS_CONFIG: $SASL_JAAS_CONFIG
      CONNECT_SASL_MECHANISM: PLAIN
      # Connect producer
      CONNECT_PRODUCER_SECURITY_PROTOCOL: SASL_SSL
      CONNECT_PRODUCER_SASL_JAAS_CONFIG: $SASL_JAAS_CONFIG
      CONNECT_PRODUCER_SASL_MECHANISM: PLAIN
      # Connect consumer
      CONNECT_CONSUMER_SECURITY_PROTOCOL: SASL_SSL
      CONNECT_CONSUMER_SASL_JAAS_CONFIG: $SASL_JAAS_CONFIG
      CONNECT_CONSUMER_SASL_MECHANISM: PLAIN
</code></pre>
<p>Run the container with:</p>
<pre><code>docker-compose up -d
</code></pre>
<p>Now you should have Syslog messages being written to the topic <code>syslog</code> in Confluent Cloud.</p>
<h3 id="run-stream-processing-app">Run stream processing app</h3>
<p>Process the syslog events by flagging events with invalid users, stripping out all the other unnecessary fields, and creating just a stream of relevant information.
There are many ways to customize the resulting stream to fit the business needs: this example also demonstrates how to enrich the stream with a new field <code>FACILITY_DESCRIPTION</code> with human-readable content.</p>
<pre><code class="language-sql">-- Define Kafka parameters
DEFINE topic = 'syslog';

-- Extract relevant fields from log messages
CREATE OR REPLACE STREAM `syslog` WITH (
  KAFKA_TOPIC = '${topic}',
  VALUE_FORMAT = 'json',
  PARTITIONS = 6
);

CREATE STREAM `by_facility` AS
  SELECT
    TIMESTAMPTOSTRING(TIMESTAMP, 'yyyy-MM-dd HH:mm:ss') AS SYSLOG_TIMESTAMP,
    HOST,
    FACILITY,
    MESSAGE,
    REMOTEADDRESS         
  FROM `syslog`
  PARTITION BY FACILITY
  EMIT CHANGES;

-- Flag events with invalid users, and enrich with a new field 'FACILITY_DESCRIPTION'
CREATE STREAM `invalid_users` AS
  SELECT
    SYSLOG_TIMESTAMP,
    HOST,
    FACILITY,
    MESSAGE, 
    REMOTEADDRESS,
    CASE WHEN FACILITY = 0 THEN 'kernel messages'
         WHEN FACILITY = 1 THEN 'user-level messages'
         WHEN FACILITY = 2 THEN 'mail system'
         WHEN FACILITY = 3 THEN 'system daemons'
         WHEN FACILITY = 4 THEN 'security/authorization messages'
         WHEN FACILITY = 5 THEN 'messages generated internally by syslogd'
         WHEN FACILITY = 6 THEN 'line printer subsystem'
         ELSE '&lt;unknown&gt;'
       END AS FACILITY_DESCRIPTION
  FROM `by_facility`
  WHERE MESSAGE LIKE 'Invalid user%'
  EMIT CHANGES;

-- Create actionable stream of SSH attacks, enriched with user and IP
CREATE STREAM `ssh_attacks` AS 
  SELECT
    SYSLOG_TIMESTAMP,
    HOST,
    FACILITY_DESCRIPTION,
    SPLIT(REPLACE(MESSAGE,'Invalid user ',''),' from ')[1] AS ATTACK_USER,
    SPLIT(REPLACE(MESSAGE,'Invalid user ',''),' from ')[2] AS ATTACK_IP
  FROM `invalid_users`
  EMIT CHANGES;
</code></pre>
<h2 id="full-ksqldb-statements">Full ksqlDB Statements</h2>
<p>Here is the full recipe that you can run with ksqlDB, a consolidation of all the the steps shown above.</p>
<p>Run the Syslog source connector locally, then proceed with ksqlDB to process the Syslog messages.</p>
<pre><code class="language-sql">-- Define Kafka parameters
DEFINE topic = 'syslog';

-- Extract relevant fields from log messages
CREATE OR REPLACE STREAM `syslog` WITH (
  KAFKA_TOPIC = '${topic}',
  VALUE_FORMAT = 'json',
  PARTITIONS = 6
);

CREATE STREAM `by_facility` AS
  SELECT
    TIMESTAMPTOSTRING(TIMESTAMP, 'yyyy-MM-dd HH:mm:ss') AS SYSLOG_TIMESTAMP,
    HOST,
    FACILITY,
    MESSAGE,
    REMOTEADDRESS         
  FROM `syslog`
  PARTITION BY FACILITY
  EMIT CHANGES;

-- Flag events with invalid users, and enrich with a new field 'FACILITY_DESCRIPTION'
CREATE STREAM `invalid_users` AS
  SELECT
    SYSLOG_TIMESTAMP,
    HOST,
    FACILITY,
    MESSAGE, 
    REMOTEADDRESS,
    CASE WHEN FACILITY = 0 THEN 'kernel messages'
         WHEN FACILITY = 1 THEN 'user-level messages'
         WHEN FACILITY = 2 THEN 'mail system'
         WHEN FACILITY = 3 THEN 'system daemons'
         WHEN FACILITY = 4 THEN 'security/authorization messages'
         WHEN FACILITY = 5 THEN 'messages generated internally by syslogd'
         WHEN FACILITY = 6 THEN 'line printer subsystem'
         ELSE '&lt;unknown&gt;'
       END AS FACILITY_DESCRIPTION
  FROM `by_facility`
  WHERE MESSAGE LIKE 'Invalid user%'
  EMIT CHANGES;

-- Create actionable stream of SSH attacks, enriched with user and IP
CREATE STREAM `ssh_attacks` AS 
  SELECT
    SYSLOG_TIMESTAMP,
    HOST,
    FACILITY_DESCRIPTION,
    SPLIT(REPLACE(MESSAGE,'Invalid user ',''),' from ')[1] AS ATTACK_USER,
    SPLIT(REPLACE(MESSAGE,'Invalid user ',''),' from ')[2] AS ATTACK_IP
  FROM `invalid_users`
  EMIT CHANGES;
</code></pre>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../../shared/ccloud_launch/" class="btn btn-neutral float-right" title="Ccloud launch">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../../retail/inventory/" class="btn btn-neutral" title="View Real-time Inventory"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../../retail/inventory/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../../shared/ccloud_launch/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme_extra.js" defer></script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
