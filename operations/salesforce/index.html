<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>Handle Corrupted Data From Salesforce - ksqlDB Recipes</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../../css/theme.css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Handle Corrupted Data From Salesforce";
    var mkdocs_page_input_path = "operations/salesforce/index.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> ksqlDB Recipes</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../..">ksqlDB Recipes</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Customer 360</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="#">Clickstream</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../customer-360/clickstream/">Understand User Behavior with Clickstream Data</a>
                </li>
    </ul>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Fin serv</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="#">Credit card activity</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../fin-serv/credit-card-activity/">Detect Unusual Credit Card Activity</a>
                </li>
    </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="#">Denormalization</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../fin-serv/denormalization/">Denormalize Change Data Capture (CDC) for Orders</a>
                </li>
    </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="#">Payment status check</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../fin-serv/payment-status-check/">Check Payment Requests</a>
                </li>
    </ul>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Internet of things</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="#">Coalesce</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../internet-of-things/coalesce/">Coalesce Telemetry</a>
                </li>
    </ul>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Operations</span></p>
                <ul class="current">
                    <li class="toctree-l1 current"><a class="reference internal current" href="#">Salesforce</a>
    <ul class="current">
                <li class="toctree-l2 current"><a class="reference internal current" href="./">Handle Corrupted Data From Salesforce</a>
    <ul class="current">
    <li class="toctree-l3"><a class="reference internal" href="#what-is-it">What is it?</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#get-started">Get Started</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#step-by-step">Step-by-step</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#setup-your-environment">Setup your Environment</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#read-the-data-in">Read the data in</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#run-stream-processing-app">Run stream processing app</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#full-ksqldb-statements">Full ksqlDB Statements</a>
    </li>
    </ul>
                </li>
    </ul>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Retail</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="#">Fleet management</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../retail/fleet_management/">Build a Real-time Fleet Management System</a>
                </li>
    </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="#">Inventory</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../retail/inventory/">View Real-time Inventory</a>
                </li>
    </ul>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Security</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="#">Ssh attack</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../security/ssh-attack/">Detect and Analyze SSH Attacks</a>
                </li>
    </ul>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Shared</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../shared/ccloud_launch/">Ccloud launch</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../shared/ccloud_setup/">Ccloud setup</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../shared/code_summary/">Code summary</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../shared/connect/">Connect</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../shared/manual_cue/">Manual cue</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../shared/manual_insert/">Manual insert</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">ksqlDB Recipes</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>Operations &raquo;</li>
        
      
        
          <li>Salesforce &raquo;</li>
        
      
    
    <li>Handle Corrupted Data From Salesforce</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  
  <hr/>
</div>

          <div role="main">
            <div class="section">
              
                <h1 id="handle-corrupted-data-from-salesforce">Handle Corrupted Data From Salesforce</h1>
<h2 id="what-is-it">What is it?</h2>
<p>Salesforce sends a notification when a change to a Salesforce record occurs as part of a create, update, delete, or undelete operation.
However, if there is corrupted data in Salesforce, it sends a gap event instead of a change event, which contains information about the change in the header, such as the change type and record ID.
These gap events need to be identified and then handled by calling a SFDC API to reconcile the events in real time.</p>
<p>TODO--diagram</p>
<h2 id="get-started">Get Started</h2>
<p>Click below to automatically launch this recipe in Confluent Cloud (alternatively: follow the step-by-step instructions that follow).</p>
<p><a href="https://www.confluent.io/confluent-cloud/tryfree/"><img src="../../img/launch.png" /></a></p>
<h2 id="step-by-step">Step-by-step</h2>
<h3 id="setup-your-environment">Setup your Environment</h3>
<p>Setup your environment in <a href="https://www.confluent.io/confluent-cloud/tryfree/">Confluent Cloud</a>, a fully-managed Apache Kafka service.</p>
<p>Then proceed with the recipe, which can be executed with <code>SQL</code> syntax using Confluent Cloud ksqlDB, which now has connector integration for reading and writing data to other data sources and sinks, as well as language for processing the data.</p>
<h3 id="read-the-data-in">Read the data in</h3>
<p>Confluent Cloud offers pre-built, fully managed connectors that make it easy to instantly connect to popular data sources and end systems in the cloud.
This recipe is shown with one example of a data source, but you can substitute your own preferred connector to use any data source.
The principles are the same, just modify the connector configuration shown below to fit your deployment (see <a href="https://docs.confluent.io/cloud/current/connectors/index.html">documentation</a>).</p>
<p>Use Avro so ksqlDB can automatically detect the schema.</p>
<pre><code class="language-sql">-- Stream of changes to Salesforce records
CREATE SOURCE CONNECTOR sfdc_cdc WITH (
  'connector.class'            = 'SalesforceCdcSource',
  'name'                       = 'SalesforceCdcSourceConnector',
  'kafka.api.key'              = '&lt;my-kafka-api-key&gt;',
  'kafka.api.secret'           = '&lt;my-kafka-api-secret&gt;',
  'kafka.topic'                = 'sfdc.cdc.raw',
  'salesforce.username'        = '&lt;my-sfdc-username&gt;',
  'salesforce.password'        = '&lt;my-sfdc-password&gt;',
  'salesforce.password.token'  = '&lt;sfdc-password-token&gt;',
  'salesforce.consumer.key'    = '&lt;sfdc-consumer-key&gt;',
  'salesforce.consumer.secret' = '&lt;sfdc-consumer-secret&gt;',
  'salesforce.cdc.name'        = 'AccountChangeEvent',
  'output.data.format'         = 'AVRO',
  'tasks.max'                  = '1'
}
</code></pre>
<h3 id="run-stream-processing-app">Run stream processing app</h3>
<pre><code class="language-sql">-- Register the stream of SFDC CDC Opportunities
CREATE STREAM STREAM_SFDC_CDC_OPPORTUNITY_RAW
WITH (
  KAFKA_TOPIC='sfdc.cdc.raw',
  VALUE_FORMAT='AVRO',
  PARTITIONS=6
);

-- Create a new stream with Replay ID and Change Event Header for just Gap Events
CREATE STREAM STREAM_SFDC_CDC_OPPORTUNITY_CHANGE_LOG AS
  SELECT
    STREAM_SFDC_CDC_OPPORTUNITY_RAW.REPLAYID AS REPLAYID,
    STREAM_SFDC_CDC_OPPORTUNITY_RAW.CHANGEEVENTHEADER AS CHANGEEVENTHEADER
  FROM STREAM_SFDC_CDC_OPPORTUNITY_RAW
  WHERE (UCASE(STREAM_SFDC_CDC_OPPORTUNITY_RAW.CHANGEEVENTHEADER-&gt;CHANGETYPE) LIKE 'GAP%')
  EMIT CHANGES;
</code></pre>
<h2 id="full-ksqldb-statements">Full ksqlDB Statements</h2>
<p>Here is the full recipe that you can run with ksqlDB, a consolidation of all the the steps shown above.</p>
<pre><code class="language-sql">-- Stream of changes to Salesforce records
CREATE SOURCE CONNECTOR sfdc_cdc WITH (
  'connector.class'            = 'SalesforceCdcSource',
  'name'                       = 'SalesforceCdcSourceConnector',
  'kafka.api.key'              = '&lt;my-kafka-api-key&gt;',
  'kafka.api.secret'           = '&lt;my-kafka-api-secret&gt;',
  'kafka.topic'                = 'sfdc.cdc.raw',
  'salesforce.username'        = '&lt;my-sfdc-username&gt;',
  'salesforce.password'        = '&lt;my-sfdc-password&gt;',
  'salesforce.password.token'  = '&lt;sfdc-password-token&gt;',
  'salesforce.consumer.key'    = '&lt;sfdc-consumer-key&gt;',
  'salesforce.consumer.secret' = '&lt;sfdc-consumer-secret&gt;',
  'salesforce.cdc.name'        = 'AccountChangeEvent',
  'output.data.format'         = 'AVRO',
  'tasks.max'                  = '1'
}

-- Register the stream of SFDC CDC Opportunities
CREATE STREAM STREAM_SFDC_CDC_OPPORTUNITY_RAW
WITH (
  KAFKA_TOPIC='sfdc.cdc.raw',
  VALUE_FORMAT='AVRO',
  PARTITIONS=6
);

-- Create a new stream with Replay ID and Change Event Header for just Gap Events
CREATE STREAM STREAM_SFDC_CDC_OPPORTUNITY_CHANGE_LOG AS
  SELECT
    STREAM_SFDC_CDC_OPPORTUNITY_RAW.REPLAYID AS REPLAYID,
    STREAM_SFDC_CDC_OPPORTUNITY_RAW.CHANGEEVENTHEADER AS CHANGEEVENTHEADER
  FROM STREAM_SFDC_CDC_OPPORTUNITY_RAW
  WHERE (UCASE(STREAM_SFDC_CDC_OPPORTUNITY_RAW.CHANGEEVENTHEADER-&gt;CHANGETYPE) LIKE 'GAP%')
  EMIT CHANGES;
</code></pre>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../../retail/fleet_management/" class="btn btn-neutral float-right" title="Build a Real-time Fleet Management System">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../../internet-of-things/coalesce/" class="btn btn-neutral" title="Coalesce Telemetry"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../../internet-of-things/coalesce/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../../retail/fleet_management/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme_extra.js" defer></script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
