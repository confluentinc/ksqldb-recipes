<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>Detect Unusual Credit Card Activity - ksqlDB Recipes</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../../css/theme.css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Detect Unusual Credit Card Activity";
    var mkdocs_page_input_path = "fin-serv/credit-card-activity/index.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> ksqlDB Recipes</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../..">ksqlDB Recipes</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Customer 360</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="#">Clickstream</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../customer-360/clickstream/">Understand User Behavior with Clickstream Data</a>
                </li>
    </ul>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Fin serv</span></p>
                <ul class="current">
                    <li class="toctree-l1 current"><a class="reference internal current" href="#">Credit card activity</a>
    <ul class="current">
                <li class="toctree-l2 current"><a class="reference internal current" href="./">Detect Unusual Credit Card Activity</a>
    <ul class="current">
    <li class="toctree-l3"><a class="reference internal" href="#what-is-it">What is it?</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#get-started">Get Started</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#step-by-step">Step-by-step</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#setup-your-environment">Setup your Environment</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#read-the-data-in">Read the data in</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#run-stream-processing-app">Run stream processing app</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#full-ksqldb-statements">Full ksqlDB Statements</a>
    </li>
    </ul>
                </li>
    </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="#">Denormalization</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../denormalization/">Denormalize Change Data Capture (CDC) for Orders</a>
                </li>
    </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="#">Payment status check</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../payment-status-check/">Check Payment Requests</a>
                </li>
    </ul>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Retail</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="#">Fleet management</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../retail/fleet_management/">Build a Real-time Fleet Management System</a>
                </li>
    </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="#">Inventory</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../retail/inventory/">View Real-time Inventory</a>
                </li>
    </ul>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Security</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="#">Ssh attack</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../security/ssh-attack/">Detect and Analyze SSH Attacks</a>
                </li>
    </ul>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Shared</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../shared/ccloud_launch/">Ccloud launch</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../shared/ccloud_setup/">Ccloud setup</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../shared/code_summary/">Code summary</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../shared/connect/">Connect</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../shared/manual_cue/">Manual cue</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../shared/manual_insert/">Manual insert</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">ksqlDB Recipes</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>Fin serv &raquo;</li>
        
      
        
          <li>Credit card activity &raquo;</li>
        
      
    
    <li>Detect Unusual Credit Card Activity</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  
  <hr/>
</div>

          <div role="main">
            <div class="section">
              
                <h1 id="detect-unusual-credit-card-activity">Detect Unusual Credit Card Activity</h1>
<h2 id="what-is-it">What is it?</h2>
<p>In banking, fraud can involve using stolen credit cards, forging checks, misleading accounting practices, etc.
This recipe analyzes total credit card spend.
If a customer exceeds their average spend, the account will be flagged as a possible case of credit card theft.</p>
<p><img alt="grafana" src="../../img/credit-card-activity.jpg" /></p>
<h2 id="get-started">Get Started</h2>
<p>Click below to automatically launch this recipe in Confluent Cloud (alternatively: follow the step-by-step instructions that follow).</p>
<p><a href="https://www.confluent.io/confluent-cloud/tryfree/"><img src="../../img/launch.png" /></a></p>
<h2 id="step-by-step">Step-by-step</h2>
<h3 id="setup-your-environment">Setup your Environment</h3>
<p>Setup your environment in <a href="https://www.confluent.io/confluent-cloud/tryfree/">Confluent Cloud</a>, a fully-managed Apache Kafka service.</p>
<p>Then proceed with the recipe, which can be executed with <code>SQL</code> syntax using Confluent Cloud ksqlDB, which now has connector integration for reading and writing data to other data sources and sinks, as well as language for processing the data.</p>
<h3 id="read-the-data-in">Read the data in</h3>
<p>Confluent Cloud offers pre-built, fully managed connectors that make it easy to instantly connect to popular data sources and end systems in the cloud.
This recipe is shown with one example of a data source, but you can substitute your own preferred connector to use any data source.
The principles are the same, just modify the connector configuration shown below to fit your deployment (see <a href="https://docs.confluent.io/cloud/current/connectors/index.html">documentation</a>).</p>
<pre><code class="language-sql">-- Stream of transactions
CREATE SOURCE CONNECTOR FD_transactions WITH (
  'connector.class'          = 'OracleDatabaseSource',
  'name'                     = 'recipe-oracle-transactions',
  'connector.class'          = 'OracleDatabaseSource',
  'kafka.api.key'            = '&lt;my-kafka-api-key&gt;',
  'kafka.api.secret'         = '&lt;my-kafka-api-secret&gt;',
  'connection.host'          = '&lt;my-database-endpoint&gt;',
  'connection.port'          = '1521',
  'connection.user'          = '&lt;database-username&gt;',
  'connection.password'      = '&lt;database-password&gt;',
  'db.name'                  = '&lt;db-name&gt;',
  'table.whitelist'          = 'TRANSACTIONS',
  'timestamp.column.name'    = 'created_at',
  'output.data.format'       = 'JSON',
  'db.timezone'              = 'UCT',
  'tasks.max'                = '1');

-- Stream of customers
CREATE SOURCE CONNECTOR FD_customers WITH (
  'connector.class'          = 'OracleDatabaseSource',
  'name'                     = 'recipe-oracle-customers',
  'connector.class'          = 'OracleDatabaseSource',
  'kafka.api.key'            = '&lt;my-kafka-api-key&gt;',
  'kafka.api.secret'         = '&lt;my-kafka-api-secret&gt;',
  'connection.host'          = '&lt;my-database-endpoint&gt;',
  'connection.port'          = '1521',
  'connection.user'          = '&lt;database-username&gt;',
  'connection.password'      = '&lt;database-password&gt;',
  'db.name'                  = '&lt;db-name&gt;',
  'table.whitelist'          = 'CUSTOMERS',
  'timestamp.column.name'    = 'created_at',
  'output.data.format'       = 'JSON',
  'db.timezone'              = 'UCT',
  'tasks.max'                = '1');
</code></pre>
<p>Optional: If you do not have a real data source to connect to with properly formatted data, or you just want to execute this recipe without external dependencies, no worries!  In the next section, we'll show you how to insert values into the streams.</p>
<h3 id="run-stream-processing-app">Run stream processing app</h3>
<p>Now you can process the data in a variety of ways.</p>
<pre><code class="language-sql">-- Register the stream of transactions
CREATE STREAM FD_TRANSACTIONS_RAW (
  ACCOUNT_ID BIGINT, 
  TIMESTAMP VARCHAR, 
  CARD_TYPE VARCHAR, 
  AMOUNT DOUBLE, 
  IP_ADDRESS VARCHAR, 
  TRANSACTION_ID VARCHAR
) WITH (
  KAFKA_TOPIC='FD_transactions',
  VALUE_FORMAT='JSON', 
  PARTITIONS=6
);

-- Repartition the stream on account_id in order to ensure that all the streams and tables are co-partitioned, which means that input records on both sides of the join have the same configuration settings for partitions.
CREATE STREAM FD_TRANSACTIONS_SOURCE AS
  SELECT * 
  FROM FD_TRANSACTIONS_RAW 
  PARTITION BY ACCOUNT_ID;

-- Register the existing stream of customer data
CREATE STREAM FD_CUST_RAW_STREAM (
  ID BIGINT, 
  FIRST_NAME VARCHAR, 
  LAST_NAME VARCHAR, 
  EMAIL VARCHAR, 
  AVG_CREDIT_SPEND DOUBLE
) WITH (
  KAFKA_TOPIC='FD_customers', 
  VALUE_FORMAT='JSON', 
  PARTITIONS=6
);

-- Repartition the customer data stream by account_id to prepare for the join
CREATE STREAM FD_CUSTOMER_REKEYED WITH (kafka_topic='FD_CUSTOMER_REKEYED') AS
  SELECT * 
  FROM FD_CUST_RAW_STREAM 
  PARTITION BY ID;

-- Register the partitioned customer data topic as a table used for the join with the incoming stream of transactions:
CREATE TABLE FD_customer (
  ID BIGINT PRIMARY KEY,
  FIRST_NAME VARCHAR, 
  LAST_NAME VARCHAR, 
  EMAIL VARCHAR, 
  AVG_CREDIT_SPEND DOUBLE
) WITH (
  KAFKA_TOPIC='FD_CUSTOMER_REKEYED',
  VALUE_FORMAT='JSON',
  PARTITIONS=6
);

-- Join the transactions to customer information:
CREATE STREAM FD_TRANSACTIONS_ENRICHED AS 
  SELECT
    T.ACCOUNT_ID,
    T.CARD_TYPE,
    T.AMOUNT, 
    C.FIRST_NAME + ' ' + C.LAST_NAME AS FULL_NAME, 
    C.AVG_CREDIT_SPEND 
  FROM FD_TRANSACTIONS_SOURCE T 
  INNER JOIN FD_CUSTOMER C 
  ON T.ACCOUNT_ID = C.ID;

-- Aggregate the stream of transactions for each account ID using a two-hour tumbling window, and filter for accounts in which the total spend in a two-hour period is greater than the customer’s average:
CREATE TABLE FD_POSSIBLE_STOLEN_CARD WITH (key_format='json') AS 
  SELECT
    TIMESTAMPTOSTRING(WINDOWSTART, 'yyyy-MM-dd HH:mm:ss Z') AS WINDOW_START, 
    T.ACCOUNT_ID,
    T.CARD_TYPE,
    SUM(T.AMOUNT) AS TOTAL_CREDIT_SPEND, 
    T.FULL_NAME,
    MAX(T.AVG_CREDIT_SPEND) AS AVG_CREDIT_SPEND 
  FROM FD_TRANSACTIONS_ENRICHED T 
  WINDOW TUMBLING (SIZE 2 HOURS) 
  GROUP BY T.ACCOUNT_ID, T.CARD_TYPE, T.FULL_NAME 
  HAVING SUM(T.AMOUNT) &gt; MAX(T.AVG_CREDIT_SPEND);
</code></pre>
<p>In the previous section <a href="#read-the-data-in">Read the data in</a>, if you did not have a real data source to connect to, you can now use ksqlDB to insert mock data into source topics with the following statements:</p>
<pre><code class="language-sql">INSERT INTO FD_transactions (account_id, timestamp, card_type, amount, ip_address, transaction_id) VALUES (6011000990139424, '2021-09-23T10:50:00.000Z', 'visa', 542.99, '192.168.44.1', '3985757');
INSERT INTO FD_transactions (account_id, timestamp, card_type, amount, ip_address, transaction_id) VALUES (6011000990139424, '2021-09-23T10:50:01.000Z', 'visa', 611.48, '192.168.44.1', '8028435');
INSERT INTO FD_transactions (account_id, timestamp, card_type, amount, ip_address, transaction_id) VALUES (3530111333300000, '2021-09-23T10:50:00.000Z', 'mastercard', 65.0, '192.168.101.3', '1695780');

INSERT INTO FD_customers (id, first_name, last_name, email, avg_credit_spend) VALUES (6011000990139424, 'Janice', 'Smith', 'jsmith@mycompany.com', 500.00);
INSERT INTO FD_customers (id, first_name, last_name, email, avg_credit_spend) VALUES (3530111333300000, 'George', 'Mall', 'gmall@mycompany.com', 20.00);
</code></pre>
<h2 id="full-ksqldb-statements">Full ksqlDB Statements</h2>
<p>Here is the full recipe that you can run with ksqlDB, a consolidation of all the the steps shown above.</p>
<pre><code class="language-sql">-- Stream of transactions
CREATE SOURCE CONNECTOR FD_transactions WITH (
  'connector.class'          = 'OracleDatabaseSource',
  'name'                     = 'recipe-oracle-transactions',
  'connector.class'          = 'OracleDatabaseSource',
  'kafka.api.key'            = '&lt;my-kafka-api-key&gt;',
  'kafka.api.secret'         = '&lt;my-kafka-api-secret&gt;',
  'connection.host'          = '&lt;my-database-endpoint&gt;',
  'connection.port'          = '1521',
  'connection.user'          = '&lt;database-username&gt;',
  'connection.password'      = '&lt;database-password&gt;',
  'db.name'                  = '&lt;db-name&gt;',
  'table.whitelist'          = 'TRANSACTIONS',
  'timestamp.column.name'    = 'created_at',
  'output.data.format'       = 'JSON',
  'db.timezone'              = 'UCT',
  'tasks.max'                = '1');

-- Stream of customers
CREATE SOURCE CONNECTOR FD_customers WITH (
  'connector.class'          = 'OracleDatabaseSource',
  'name'                     = 'recipe-oracle-customers',
  'connector.class'          = 'OracleDatabaseSource',
  'kafka.api.key'            = '&lt;my-kafka-api-key&gt;',
  'kafka.api.secret'         = '&lt;my-kafka-api-secret&gt;',
  'connection.host'          = '&lt;my-database-endpoint&gt;',
  'connection.port'          = '1521',
  'connection.user'          = '&lt;database-username&gt;',
  'connection.password'      = '&lt;database-password&gt;',
  'db.name'                  = '&lt;db-name&gt;',
  'table.whitelist'          = 'CUSTOMERS',
  'timestamp.column.name'    = 'created_at',
  'output.data.format'       = 'JSON',
  'db.timezone'              = 'UCT',
  'tasks.max'                = '1');

-- Register the stream of transactions
CREATE STREAM FD_TRANSACTIONS_RAW (
  ACCOUNT_ID BIGINT, 
  TIMESTAMP VARCHAR, 
  CARD_TYPE VARCHAR, 
  AMOUNT DOUBLE, 
  IP_ADDRESS VARCHAR, 
  TRANSACTION_ID VARCHAR
) WITH (
  KAFKA_TOPIC='FD_transactions',
  VALUE_FORMAT='JSON', 
  PARTITIONS=6
);

-- Repartition the stream on account_id in order to ensure that all the streams and tables are co-partitioned, which means that input records on both sides of the join have the same configuration settings for partitions.
CREATE STREAM FD_TRANSACTIONS_SOURCE AS
  SELECT * 
  FROM FD_TRANSACTIONS_RAW 
  PARTITION BY ACCOUNT_ID;

-- Register the existing stream of customer data
CREATE STREAM FD_CUST_RAW_STREAM (
  ID BIGINT, 
  FIRST_NAME VARCHAR, 
  LAST_NAME VARCHAR, 
  EMAIL VARCHAR, 
  AVG_CREDIT_SPEND DOUBLE
) WITH (
  KAFKA_TOPIC='FD_customers', 
  VALUE_FORMAT='JSON', 
  PARTITIONS=6
);

-- Repartition the customer data stream by account_id to prepare for the join
CREATE STREAM FD_CUSTOMER_REKEYED WITH (kafka_topic='FD_CUSTOMER_REKEYED') AS
  SELECT * 
  FROM FD_CUST_RAW_STREAM 
  PARTITION BY ID;

-- Register the partitioned customer data topic as a table used for the join with the incoming stream of transactions:
CREATE TABLE FD_customer (
  ID BIGINT PRIMARY KEY,
  FIRST_NAME VARCHAR, 
  LAST_NAME VARCHAR, 
  EMAIL VARCHAR, 
  AVG_CREDIT_SPEND DOUBLE
) WITH (
  KAFKA_TOPIC='FD_CUSTOMER_REKEYED',
  VALUE_FORMAT='JSON',
  PARTITIONS=6
);

-- Join the transactions to customer information:
CREATE STREAM FD_TRANSACTIONS_ENRICHED AS 
  SELECT
    T.ACCOUNT_ID,
    T.CARD_TYPE,
    T.AMOUNT, 
    C.FIRST_NAME + ' ' + C.LAST_NAME AS FULL_NAME, 
    C.AVG_CREDIT_SPEND 
  FROM FD_TRANSACTIONS_SOURCE T 
  INNER JOIN FD_CUSTOMER C 
  ON T.ACCOUNT_ID = C.ID;

-- Aggregate the stream of transactions for each account ID using a two-hour tumbling window, and filter for accounts in which the total spend in a two-hour period is greater than the customer’s average:
CREATE TABLE FD_POSSIBLE_STOLEN_CARD WITH (key_format='json') AS 
  SELECT
    TIMESTAMPTOSTRING(WINDOWSTART, 'yyyy-MM-dd HH:mm:ss Z') AS WINDOW_START, 
    T.ACCOUNT_ID,
    T.CARD_TYPE,
    SUM(T.AMOUNT) AS TOTAL_CREDIT_SPEND, 
    T.FULL_NAME,
    MAX(T.AVG_CREDIT_SPEND) AS AVG_CREDIT_SPEND 
  FROM FD_TRANSACTIONS_ENRICHED T 
  WINDOW TUMBLING (SIZE 2 HOURS) 
  GROUP BY T.ACCOUNT_ID, T.CARD_TYPE, T.FULL_NAME 
  HAVING SUM(T.AMOUNT) &gt; MAX(T.AVG_CREDIT_SPEND);

</code></pre>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../denormalization/" class="btn btn-neutral float-right" title="Denormalize Change Data Capture (CDC) for Orders">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../../customer-360/clickstream/" class="btn btn-neutral" title="Understand User Behavior with Clickstream Data"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../../customer-360/clickstream/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../denormalization/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme_extra.js" defer></script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
