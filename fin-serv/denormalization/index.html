<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>Denormalize Change Data Capture (CDC) for Orders - ksqlDB Recipes</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../../css/theme.css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Denormalize Change Data Capture (CDC) for Orders";
    var mkdocs_page_input_path = "fin-serv/denormalization/index.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> ksqlDB Recipes</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../..">ksqlDB Recipes</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Customer 360</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="#">Clickstream</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../customer-360/clickstream/">Understand User Behavior with Clickstream Data</a>
                </li>
    </ul>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Fin serv</span></p>
                <ul class="current">
                    <li class="toctree-l1"><a class="reference internal" href="#">Credit card activity</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../credit-card-activity/">Detect Unusual Credit Card Activity</a>
                </li>
    </ul>
                    </li>
                    <li class="toctree-l1 current"><a class="reference internal current" href="#">Denormalization</a>
    <ul class="current">
                <li class="toctree-l2 current"><a class="reference internal current" href="./">Denormalize Change Data Capture (CDC) for Orders</a>
    <ul class="current">
    <li class="toctree-l3"><a class="reference internal" href="#what-is-it">What is it?</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#step-by-step">Step-by-step</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#setup-your-environment">Setup your Environment</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#read-the-data-in">Read the data in</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#run-stream-processing-app">Run stream processing app</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#write-the-data-out">Write the data out</a>
    </li>
        </ul>
    </li>
    </ul>
                </li>
    </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="#">Payment status check</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../payment-status-check/">Check Payment Requests</a>
                </li>
    </ul>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Internet of things</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="#">Coalesce</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../internet-of-things/coalesce/">Coalesce Telemetry</a>
                </li>
    </ul>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Operations</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="#">Salesforce</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../operations/salesforce/">Handle Corrupted Data From Salesforce</a>
                </li>
    </ul>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Retail</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="#">Dynamic pricing</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../retail/dynamic_pricing/">Set Dynamic Pricing</a>
                </li>
    </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="#">Fleet management</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../retail/fleet_management/">Build a Real-time Fleet Management System</a>
                </li>
    </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="#">Inventory</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../retail/inventory/">View Real-time Inventory</a>
                </li>
    </ul>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Security</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="#">Ssh attack</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../security/ssh-attack/">Detect and Analyze SSH Attacks</a>
                </li>
    </ul>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Shared</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../shared/ccloud_launch/">Ccloud launch</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../shared/ccloud_setup/">Ccloud setup</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../shared/code_summary/">Code summary</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../shared/connect/">Connect</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../shared/manual_cue/">Manual cue</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../shared/manual_insert/">Manual insert</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">ksqlDB Recipes</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>Fin serv &raquo;</li>
        
      
        
          <li>Denormalization &raquo;</li>
        
      
    
    <li>Denormalize Change Data Capture (CDC) for Orders</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  
  <hr/>
</div>

          <div role="main">
            <div class="section">
              
                <h1 id="denormalize-change-data-capture-cdc-for-orders">Denormalize Change Data Capture (CDC) for Orders</h1>
<h2 id="what-is-it">What is it?</h2>
<p>If you have transactional events for orders in a marketplace, you can stream the Change Data Capture (CDC) and denormalize the events.
Denormalization is a well-established pattern for performance because querying a single table of enriched data will often perform better than querying across multiple at runtime.
You can consume the denormalized events from  downstream applications in your business, or stream them to another destination.
This recipe demonstrates this principle by streaming from a SQL Server, denormalizing the data, and writing to Snowflake.</p>
<p><img alt="denormalized" src="../../img/denormalized-data.png" /></p>
<h2 id="step-by-step">Step-by-step</h2>
<h3 id="setup-your-environment">Setup your Environment</h3>
<p>Setup your environment in <a href="https://www.confluent.io/confluent-cloud/tryfree/">Confluent Cloud</a>, a fully-managed Apache Kafka service.</p>
<p>Then execute the recipe with <code>SQL</code> syntax using Confluent Cloud ksqlDB, which has language for processing the data in real-time (and will soon support connector integration for reading and writing data to other data sources and sinks).</p>
<h3 id="read-the-data-in">Read the data in</h3>
<p>Confluent Cloud offers pre-built, fully managed connectors that make it easy to instantly connect to popular data sources and end systems in the cloud.
This recipe shows one example of a data source, but you can substitute your own preferred connector to use any data source.
The principles are the same, just modify the connector configuration shown below to fit your deployment (see <a href="https://docs.confluent.io/cloud/current/connectors/index.html">documentation</a>).</p>
<p>To run a fully-managed connector to write the data into Kafka topics, use Confluent Cloud Console or <a href="https://docs.confluent.io/confluent-cli/current/overview.html">Confluent CLI</a> command <code>confluent connect create --config &lt;file&gt;</code>, submit each connector separately.</p>
<p>Change Data Capture (CDC) for orders is being written to a SQL Server database, and there is an Oracle database with customer data.</p>
<pre><code class="language-json">{
  'connector.class'          : 'SqlServerCdcSource',
  'name'                     : 'recipe-sqlservercdc-orders',
  'kafka.api.key'            : '&lt;my-kafka-api-key&gt;',
  'kafka.api.secret'         : '&lt;my-kafka-api-secret&gt;',
  'database.hostname'        : '&lt;db-name&gt;',
  'database.port'            : '1433',
  'database.user'            : '&lt;database-username&gt;',
  'database.password'        : '&lt;database-password&gt;',
  'database.dbname'          : 'database-name',
  'database.server.name'     : 'sql',
  'table.include.list'       :'&lt;table_name&gt;',
  'snapshot.mode'            : 'initial',
  'output.data.format'       : 'JSON',
  'tasks.max'                : '1'
}

{
  'connector.class'          : 'OracleDatabaseSource',
  'name'                     : 'recipe-oracle-customers',
  'connector.class'          : 'OracleDatabaseSource',
  'kafka.api.key'            : '&lt;my-kafka-api-key&gt;',
  'kafka.api.secret'         : '&lt;my-kafka-api-secret&gt;',
  'topic.prefix'             : 'oracle_',
  'connection.host'          : '&lt;my-database-endpoint&gt;',
  'connection.port'          : '1521',
  'connection.user'          : '&lt;database-username&gt;',
  'connection.password'      : '&lt;database-password&gt;',
  'db.name'                  : '&lt;db-name&gt;',
  'table.whitelist'          : 'CUSTOMERS',
  'timestamp.column.name'    : 'created_at',
  'output.data.format'       : 'JSON',
  'db.timezone'              : 'UCT',
  'tasks.max'                : '1'
}
</code></pre>
<p>Optional: If you do not have a real data source to connect to with properly formatted data, or you just want to execute this recipe without external dependencies, no worries!  In the next section, we'll show you how to insert values into the streams.</p>
<h3 id="run-stream-processing-app">Run stream processing app</h3>
<p>This streams the user orders and denormalizes the data by joining facts (orders) with the dimension (customer).</p>
<pre><code class="language-sql">-- Stream of user orders:
CREATE STREAM orders (
  ORDER_ID BIGINT,
  CUSTOMER_ID BIGINT,
  ITEM VARCHAR,
  ORDER_TOTAL_USD DOUBLE
) WITH (
  kafka_topic = 'orders',
  value_format = 'json',
  partitions = 6
);

-- Register the existing stream of customer data
CREATE STREAM CUST_RAW_STREAM (
  ID BIGINT,
  FIRST_NAME VARCHAR,
  LAST_NAME VARCHAR,
  EMAIL VARCHAR
) WITH (
  KAFKA_TOPIC='customers',
  VALUE_FORMAT='JSON',
  PARTITIONS = 6
);

-- Register the customer data topic as a table
CREATE TABLE customer (
  ID BIGINT PRIMARY KEY
) WITH (
  KAFKA_TOPIC='CUST_RAW_STREAM',
  VALUE_FORMAT='JSON',
  PARTITIONS=6
);

-- Denormalize data: joining facts (orders) with the dimension (customer)
CREATE STREAM ORDERS_ENRICHED AS
  SELECT
    O.order_id AS order_id,
    O.item AS item,
    O.order_total_usd AS order_total_usd,
    C.first_name || ' ' || C.last_name AS full_name,
    C.email AS email
  FROM ORDERS O
  LEFT JOIN
  CUSTOMERS C
  ON O.customer_id = C.id;
</code></pre>
<p>In the previous section <a href="#read-the-data-in">Read the data in</a>, if you did not have a real data source to connect to, you can now use ksqlDB to insert mock data into source topics with the following statements:</p>
<pre><code class="language-sql">INSERT INTO orders (order_id, customer_id, item, order_total_usd) VALUES (44697328, 375, 'book', 29.99);
INSERT INTO orders (order_id, customer_id, item, order_total_usd) VALUES (44697329, 375, 'guitar', 215.99);
INSERT INTO orders (order_id, customer_id, item, order_total_usd) VALUES (44697330, 983, 'thermometer', 12.99);
INSERT INTO orders (order_id, customer_id, item, order_total_usd) VALUES (44697331, 983, 'scarf', 32.99);
INSERT INTO orders (order_id, customer_id, item, order_total_usd) VALUES (44697332, 375, 'doormat', 15.99);
INSERT INTO orders (order_id, customer_id, item, order_total_usd) VALUES (44697333, 983, 'clippers', 65.99);

INSERT INTO customers (id, first_name, last_name, email) VALUES (375, 'Janice', 'Smith', 'jsmith@mycompany.com');
INSERT INTO customers (id, first_name, last_name, email) VALUES (983, 'George', 'Mall', 'gmall@mycompany.com');
</code></pre>
<h3 id="write-the-data-out">Write the data out</h3>
<p>Any downstream application or database can receive the denormalized data.</p>
<pre><code class="language-json">{
  'connector.class'          : 'SnowflakeSink',
  'name'                     : 'recipe-snowflake-analyzed_clickstream',
  'kafka.api.key'            : '&lt;my-kafka-api-key&gt;',
  'kafka.api.secret'         : '&lt;my-kafka-api-secret&gt;',
  'topics'                   : 'ORDERS_ENRICHED',
  'input.data.format'        : 'JSON',
  'snowflake.url.name'       : 'https://wm83168.us-central1.gcp.snowflakecomputing.com:443',
  'snowflake.user.name'      : '&lt;login-username&gt;',
  'snowflake.private.key'    : '&lt;private-key&gt;',
  'snowflake.database.name'  : '&lt;database-name&gt;',
  'snowflake.schema.name'    : '&lt;schema-name&gt;',
  'tasks.max'                : '1'
}
</code></pre>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../payment-status-check/" class="btn btn-neutral float-right" title="Check Payment Requests">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../credit-card-activity/" class="btn btn-neutral" title="Detect Unusual Credit Card Activity"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../credit-card-activity/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../payment-status-check/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme_extra.js" defer></script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
