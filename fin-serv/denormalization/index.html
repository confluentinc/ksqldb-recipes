<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>Change Data Capture (CDC) for Orders - ksqlDB Recipes</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../../css/theme.css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Change Data Capture (CDC) for Orders";
    var mkdocs_page_input_path = "fin-serv/denormalization/index.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> ksqlDB Recipes</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../..">ksqlDB Recipes</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Customer 360</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="#">Clickstream</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../customer-360/clickstream/">Clickstream Data Analysis</a>
                </li>
    </ul>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Fin serv</span></p>
                <ul class="current">
                    <li class="toctree-l1"><a class="reference internal" href="#">Credit card activity</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../credit-card-activity/">Detecting Unusual Credit Card Activity</a>
                </li>
    </ul>
                    </li>
                    <li class="toctree-l1 current"><a class="reference internal current" href="#">Denormalization</a>
    <ul class="current">
                <li class="toctree-l2 current"><a class="reference internal current" href="./">Change Data Capture (CDC) for Orders</a>
    <ul class="current">
    <li class="toctree-l3"><a class="reference internal" href="#what-is-it">What is it?</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#get-started">Get Started</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#step-by-step">Step-by-step</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#setup-your-environment">Setup your Environment</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#read-the-data-in">Read the data in</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#run-stream-processing-app">Run stream processing app</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#write-the-data-out">Write the data out</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#full-ksqldb-statements">Full ksqlDB Statements</a>
    </li>
    </ul>
                </li>
    </ul>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Retail</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="#">Fleet management</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../retail/fleet_management/">Fleet Management</a>
                </li>
    </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="#">Inventory</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../retail/inventory/">Real-time Inventory</a>
                </li>
    </ul>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Security</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="#">Ssh attack</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../security/ssh-attack/">Detecting and Analyzing SSH Attacks</a>
                </li>
    </ul>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Shared</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../shared/ccloud_launch/">Ccloud launch</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../shared/ccloud_setup/">Ccloud setup</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../shared/code_summary/">Code summary</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../shared/connect/">Connect</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../shared/manual_cue/">Manual cue</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../shared/manual_insert/">Manual insert</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">ksqlDB Recipes</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>Fin serv &raquo;</li>
        
      
        
          <li>Denormalization &raquo;</li>
        
      
    
    <li>Change Data Capture (CDC) for Orders</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  
  <hr/>
</div>

          <div role="main">
            <div class="section">
              
                <h1 id="change-data-capture-cdc-for-orders">Change Data Capture (CDC) for Orders</h1>
<h2 id="what-is-it">What is it?</h2>
<p>If you have transactional events for orders in a marketplace, you can stream the Change Data Capture (CDC) and denormalize it.
Denormalization is a well-established pattern for performance, because most times querying a single table of data will perform better than querying across multiple at runtime.
Then open it up to be consumed by downstream applications in your business, or stream it out to another destination.
This recipe demonstrates this principle by streaming from a SQL Server, denormalizing the data, and writing to Snowflake. </p>
<p><img alt="denormalized" src="../../img/denormalized-data.png" /></p>
<h2 id="get-started">Get Started</h2>
<p>Click below to automatically launch this recipe in Confluent Cloud (alternatively: follow the step-by-step instructions that follow).</p>
<p><a href="https://www.confluent.io/confluent-cloud/tryfree/"><img src="../../img/launch.png" /></a></p>
<h2 id="step-by-step">Step-by-step</h2>
<h3 id="setup-your-environment">Setup your Environment</h3>
<p>Setup your environment in <a href="https://www.confluent.io/confluent-cloud/tryfree/">Confluent Cloud</a>, a fully-managed Apache Kafka service.</p>
<p>Then proceed with the recipe, which can be executed with <code>SQL</code> syntax using Confluent Cloud ksqlDB, which now has connector integration for reading and writing data to other data sources and sinks, as well as language for processing the data.</p>
<h3 id="read-the-data-in">Read the data in</h3>
<p>Confluent Cloud offers pre-built, fully managed, Apache KafkaÂ® Connectors that make it easy to instantly connect to popular data sources in the cloud.
You can use any connector, substitute your own preferred one for getting data into Confluent Cloud.
The principles are the same, just modify the connector configuration shown below to fit your data source, see <a href="https://docs.confluent.io/cloud/current/connectors/index.html">documentation</a> for details.</p>
<p>Change Data Capture (CDC) for orders is being written to a SQL Server database, and there is an Oracle database with customer data.</p>
<pre><code class="language-sql">-- Stream of orders
CREATE SOURCE CONNECTOR orders WITH (
  'connector.class'          = 'SqlServerCdcSource',
  'name'                     = 'SqlServerCdcSourceConnector_0',
  'kafka.api.key'            = '&lt;my-kafka-api-key&gt;',
  'kafka.api.secret'         = '&lt;my-kafka-api-secret&gt;',
  'database.hostname'        = '&lt;db-name&gt;',
  'database.port'            = '1433',
  'database.user'            = '&lt;database-username&gt;',
  'database.password'        = '&lt;database-password&gt;',
  'database.dbname'          = 'database-name',
  'database.server.name'     = 'sql',
  'table.include.list'       ='&lt;table_name&gt;',
  'snapshot.mode'            = 'initial',
  'output.data.format'       = 'JSON',
  'tasks.max'                = '1');

-- Stream of customers
CREATE SOURCE CONNECTOR customers WITH (
  'connector.class'          = 'OracleDatabaseSource',
  'name'                     = 'confluent-oracle-source',
  'connector.class'          = 'OracleDatabaseSource',
  'kafka.api.key'            = '&lt;my-kafka-api-key&gt;',
  'kafka.api.secret'         = '&lt;my-kafka-api-secret&gt;',
  'topic.prefix'             = 'oracle_',
  'connection.host'          = '&lt;my-database-endpoint&gt;',
  'connection.port'          = '1521',
  'connection.user'          = '&lt;database-username&gt;',
  'connection.password'      = '&lt;database-password&gt;',
  'db.name'                  = '&lt;db-name&gt;',
  'table.whitelist'          = 'CUSTOMERS',
  'timestamp.column.name'    = 'created_at',
  'output.data.format'       = 'JSON',
  'db.timezone'              = 'UCT',
  'tasks.max'                = '1');
</code></pre>
<h3 id="run-stream-processing-app">Run stream processing app</h3>
<p>This streams the user orders and denormalizes the data by joining facts (orders) with the dimension (customer).</p>
<pre><code class="language-sql">-- stream of user orders:
CREATE STREAM orders (
        ...
    ) with (
        kafka_topic = 'orders',
        value_format = 'json'
    );

-- Register the existing stream of customer data
CREATE STREAM CUST_RAW_STREAM (ID BIGINT,
                               FIRST_NAME VARCHAR,
                               LAST_NAME VARCHAR,
                               EMAIL VARCHAR,
                               COMPANY VARCHAR,
                               STREET_ADDRESS VARCHAR,
                               CITY VARCHAR,
                               COUNTRY VARCHAR)
              WITH (KAFKA_TOPIC='customers',
                    VALUE_FORMAT='JSON');

-- Register the customer data topic as a table
CREATE TABLE customer
WITH (KAFKA_TOPIC='CUST_RAW_STREAM',
      VALUE_FORMAT='JSON',
      KEY='ID');

-- Denormalize data: joining facts (orders) with the dimension (customer)
CREATE STREAM ORDERS_ENRICHED AS
    SELECT  O.order_id AS order_id,
            O.item AS item,
            O.order_total_usd AS order_total_usd,
            C.first_name || ' ' || C.last_name AS full_name,
            C.email AS email,
            C.company AS company,
            C.street_address AS street_address,
            C.city AS city,
            C.country AS country
    FROM    ORDERS O
            LEFT JOIN
            CUSTOMERS C
            ON O.customer_id = C.id;
</code></pre>
<h3 id="write-the-data-out">Write the data out</h3>
<p>Any downstream application or database can receive the denormalized data.</p>
<pre><code class="language-sql">-- Send data to Snowflake
CREATE SINK CONNECTOR analyzed_clickstream WITH (
  'connector.class'          = 'SnowflakeSink',
  'name'                     = 'snowflake-connector',
  'kafka.api.key'            = '&lt;my-kafka-api-key&gt;',
  'kafka.api.secret'         = '&lt;my-kafka-api-secret&gt;',
  'topics'                   = '&lt;topic1&gt;, &lt;topic2&gt;',
  'input.data.format'        = 'JSON',
  'snowflake.url.name'       = 'https=//wm83168.us-central1.gcp.snowflakecomputing.com=443',
  'snowflake.user.name'      = '&lt;login-username&gt;',
  'snowflake.private.key'    = '&lt;private-key&gt;',
  'snowflake.database.name'  = '&lt;database-name&gt;',
  'snowflake.schema.name'    = '&lt;schema-name&gt;',
  'tasks.max'                = '1');
</code></pre>
<h2 id="full-ksqldb-statements">Full ksqlDB Statements</h2>
<p>Here is a complete view of all the recipe steps explained above.</p>
<pre><code class="language-sql">-- Stream of orders
CREATE SOURCE CONNECTOR orders WITH (
  'connector.class'          = 'SqlServerCdcSource',
  'name'                     = 'SqlServerCdcSourceConnector_0',
  'kafka.api.key'            = '&lt;my-kafka-api-key&gt;',
  'kafka.api.secret'         = '&lt;my-kafka-api-secret&gt;',
  'database.hostname'        = '&lt;db-name&gt;',
  'database.port'            = '1433',
  'database.user'            = '&lt;database-username&gt;',
  'database.password'        = '&lt;database-password&gt;',
  'database.dbname'          = 'database-name',
  'database.server.name'     = 'sql',
  'table.include.list'       ='&lt;table_name&gt;',
  'snapshot.mode'            = 'initial',
  'output.data.format'       = 'JSON',
  'tasks.max'                = '1');

-- Stream of customers
CREATE SOURCE CONNECTOR customers WITH (
  'connector.class'          = 'OracleDatabaseSource',
  'name'                     = 'confluent-oracle-source',
  'connector.class'          = 'OracleDatabaseSource',
  'kafka.api.key'            = '&lt;my-kafka-api-key&gt;',
  'kafka.api.secret'         = '&lt;my-kafka-api-secret&gt;',
  'topic.prefix'             = 'oracle_',
  'connection.host'          = '&lt;my-database-endpoint&gt;',
  'connection.port'          = '1521',
  'connection.user'          = '&lt;database-username&gt;',
  'connection.password'      = '&lt;database-password&gt;',
  'db.name'                  = '&lt;db-name&gt;',
  'table.whitelist'          = 'CUSTOMERS',
  'timestamp.column.name'    = 'created_at',
  'output.data.format'       = 'JSON',
  'db.timezone'              = 'UCT',
  'tasks.max'                = '1');

-- stream of user orders:
CREATE STREAM orders (
        ...
    ) with (
        kafka_topic = 'orders',
        value_format = 'json'
    );

-- Register the existing stream of customer data
CREATE STREAM CUST_RAW_STREAM (ID BIGINT,
                               FIRST_NAME VARCHAR,
                               LAST_NAME VARCHAR,
                               EMAIL VARCHAR,
                               COMPANY VARCHAR,
                               STREET_ADDRESS VARCHAR,
                               CITY VARCHAR,
                               COUNTRY VARCHAR)
              WITH (KAFKA_TOPIC='customers',
                    VALUE_FORMAT='JSON');

-- Register the customer data topic as a table
CREATE TABLE customer
WITH (KAFKA_TOPIC='CUST_RAW_STREAM',
      VALUE_FORMAT='JSON',
      KEY='ID');

-- Denormalize data: joining facts (orders) with the dimension (customer)
CREATE STREAM ORDERS_ENRICHED AS
    SELECT  O.order_id AS order_id,
            O.item AS item,
            O.order_total_usd AS order_total_usd,
            C.first_name || ' ' || C.last_name AS full_name,
            C.email AS email,
            C.company AS company,
            C.street_address AS street_address,
            C.city AS city,
            C.country AS country
    FROM    ORDERS O
            LEFT JOIN
            CUSTOMERS C
            ON O.customer_id = C.id;

-- Send data to Snowflake
CREATE SINK CONNECTOR analyzed_clickstream WITH (
  'connector.class'          = 'SnowflakeSink',
  'name'                     = 'snowflake-connector',
  'kafka.api.key'            = '&lt;my-kafka-api-key&gt;',
  'kafka.api.secret'         = '&lt;my-kafka-api-secret&gt;',
  'topics'                   = '&lt;topic1&gt;, &lt;topic2&gt;',
  'input.data.format'        = 'JSON',
  'snowflake.url.name'       = 'https=//wm83168.us-central1.gcp.snowflakecomputing.com=443',
  'snowflake.user.name'      = '&lt;login-username&gt;',
  'snowflake.private.key'    = '&lt;private-key&gt;',
  'snowflake.database.name'  = '&lt;database-name&gt;',
  'snowflake.schema.name'    = '&lt;schema-name&gt;',
  'tasks.max'                = '1');
</code></pre>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../../retail/fleet_management/" class="btn btn-neutral float-right" title="Fleet Management">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../credit-card-activity/" class="btn btn-neutral" title="Detecting Unusual Credit Card Activity"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../credit-card-activity/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../../retail/fleet_management/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme_extra.js" defer></script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
